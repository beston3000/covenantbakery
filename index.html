<!DOCTYPE html>
<html>
<head>
  <title>Bakery</title>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
</head>
<body>
  <h1>üç∞ Welcome to the Bakery</h1>

  <div id="auth">
    <input id="email" placeholder="Email">
    <input id="password" type="password" placeholder="Password">
    <button onclick="signUp()">Sign Up</button>
    <button onclick="signIn()">Sign In</button>
    <button onclick="signOut()">Logout</button>
  </div>

  <div id="admin-controls" style="display: none; margin-top: 10px;">
    <button onclick="showAddItemForm()">‚ûï Add New Item</button>
  </div>

  <div id="add-item-form" style="display:none; margin-top: 10px;">
    <input id="item-name" placeholder="Name"><br>
    <input id="item-description" placeholder="Description"><br>
    <input id="item-price" type="number" placeholder="Price"><br>
    <input id="item-emoji" placeholder="Emoji (like üçû or üßÅ)"><br>
    <button onclick="submitNewItem()">Submit</button>
    <button onclick="hideAddItemForm()">Cancel</button>
  </div>

  <h2>üì¶ Stock</h2>
  <div id="menu"></div>

  <h2>üõí Cart</h2>
  <div id="cart"></div>
  <button onclick="checkout()">Checkout</button>

  <script>
    const firebaseConfig = {
      // üîê Fill in your Firebase config
      apiKey: "YOUR_API_KEY",
      authDomain: "YOUR_AUTH_DOMAIN",
      projectId: "YOUR_PROJECT_ID",
      storageBucket: "YOUR_BUCKET",
      messagingSenderId: "YOUR_SENDER_ID",
      appId: "YOUR_APP_ID"
    };
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();

    let currentUser = null;
    let userData = null;
    let cart = [];

    auth.onAuthStateChanged(async (user) => {
      if (user) {
        currentUser = user;
        const doc = await db.collection('users').doc(user.uid).get();
        userData = doc.data();

        console.log("Signed in as:", userData);

        if (userData.role === 'admin') {
          document.getElementById('admin-controls').style.display = 'block';
        }

        loadMenuItems();
      } else {
        currentUser = null;
        userData = null;
        document.getElementById('admin-controls').style.display = 'none';
        document.getElementById('menu').innerHTML = '';
        document.getElementById('cart').innerHTML = '';
      }
    });

    async function signUp() {
      const email = document.getElementById('email').value;
      const password = document.getElementById('password').value;
      try {
        const result = await auth.createUserWithEmailAndPassword(email, password);
        await db.collection('users').doc(result.user.uid).set({
          email,
          role: 'customer',
          createdAt: firebase.firestore.FieldValue.serverTimestamp()
        });
        alert("Account created!");
      } catch (error) {
        alert(getFriendlyError(error));
      }
    }

    async function signIn() {
      const email = document.getElementById('email').value;
      const password = document.getElementById('password').value;
      try {
        await auth.signInWithEmailAndPassword(email, password);
      } catch (error) {
        alert(getFriendlyError(error));
      }
    }

    function signOut() {
      auth.signOut();
    }

    function getFriendlyError(error) {
      if (error.code === 'auth/user-not-found') return 'No account found with this email.';
      if (error.code === 'auth/wrong-password') return 'Incorrect password.';
      if (error.code === 'auth/invalid-email') return 'Invalid email.';
      if (error.code === 'auth/invalid-credential') return 'Login expired or invalid. Try again.';
      return error.message;
    }

    async function loadMenuItems() {
      const snapshot = await db.collection('menuItems').where('inStock', '==', true).get();
      const menuDiv = document.getElementById('menu');
      menuDiv.innerHTML = '';
      snapshot.forEach(doc => {
        const item = doc.data();
        const div = document.createElement('div');
        div.innerHTML = `${item.emoji || ''} <b>${item.name}</b> - $${item.price}<br>${item.description}<br><button onclick="addToCart('${doc.id}', '${item.name}', ${item.price})">Add to Cart</button><hr>`;
        menuDiv.appendChild(div);
      });
    }

    function addToCart(id, name, price) {
      cart.push({ id, name, price });
      renderCart();
    }

    function renderCart() {
      const cartDiv = document.getElementById('cart');
      cartDiv.innerHTML = '';
      let total = 0;
      cart.forEach(item => {
        total += item.price;
        cartDiv.innerHTML += `${item.name} - $${item.price}<br>`;
      });
      cartDiv.innerHTML += `<b>Total: $${total.toFixed(2)}</b>`;
    }

    async function checkout() {
      if (!currentUser) {
        alert("Sign in first.");
        return;
      }
      if (cart.length === 0) {
        alert("Cart is empty.");
        return;
      }

      try {
        await db.collection('orders').add({
          userId: currentUser.uid,
          items: cart,
          createdAt: firebase.firestore.FieldValue.serverTimestamp()
        });
        alert("Order placed!");
        cart = [];
        renderCart();
      } catch (err) {
        console.error("Checkout error:", err);
        alert("Failed to place order.");
      }
    }

    function showAddItemForm() {
      document.getElementById('add-item-form').style.display = 'block';
    }

    function hideAddItemForm() {
      document.getElementById('add-item-form').style.display = 'none';
    }

    async function submitNewItem() {
      const name = document.getElementById('item-name').value;
      const description = document.getElementById('item-description').value;
      const price = parseFloat(document.getElementById('item-price').value);
      const emoji = document.getElementById('item-emoji').value;

      if (!name || !description || isNaN(price) || !emoji) {
        alert("Please fill in all fields.");
        return;
      }

      try {
        await db.collection('menuItems').add({
          name,
          description,
          price,
          emoji,
          inStock: true,
          createdAt: firebase.firestore.FieldValue.serverTimestamp()
        });
        alert("Item added!");
        hideAddItemForm();
        loadMenuItems();
      } catch (err) {
        console.error("Add item error:", err);
        alert("Failed to add item.");
      }
    }
  </script>
</body>
</html>
